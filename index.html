<!DOCTYPE html>
<html lang="es-ES">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Simulador de Crédito Avanzado</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    /* Estilo para inputs de margem quando estão desabilitados no modo de edição (ex: para parcelas acima de 20) */
    .margem-input-disabled {
      background-color: #e2e8f0; /* bg-gray-200 */
      cursor: not-allowed;
    }
  </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
  <div class="container bg-white shadow-xl rounded-xl p-8 md:p-10 lg:p-12 max-w-4xl w-full mx-auto my-8">
    
    <div class="flex justify-center mb-8">
        <img src="logo.png" alt="Logo de la Empresa" class="h-20 max-w-full"> </div>
    
    <h1 class="text-4xl font-extrabold text-center text-gray-900 mb-8">Simulador de Crédito</h1>

    <div class="mb-6">
      <label for="statusCarga" class="block text-lg font-semibold text-gray-800 mb-2">Estado de Carga de Datos:</label>
      <span id="fileName" class="ml-3 text-gray-600">Cargando datos del archivo JSON...</span>
      <div id="loadingIndicator" class="hidden mt-2 text-blue-600 font-medium">Cargando datos...</div>
    </div>

    <div class="flex flex-col md:flex-row gap-4 mt-8 mb-6">
      <button onclick="tentarEntrarModoEdicao()" id="btnModoEdicion" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-200 ease-in-out">
        Entrar en Modo Edición
      </button>
    </div>

    <div id="painelEdicaoMargens" class="hidden bg-orange-50 border border-orange-200 text-orange-800 p-6 rounded-lg mb-8 shadow-inner">
      <h3 class="text-2xl font-semibold text-gray-800 mb-4">Editar Margens de Lucro por Cuotas</h3>
      <div class="mb-4">
        <label for="selectProdutoEdicao" class="block text-sm font-medium text-gray-700 mb-1">Seleccionar Producto</label>
        <select id="selectProdutoEdicao" onchange="popularMargensEdicao()"
          class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
          <option value="">Seleccione un producto</option>
        </select>
      </div>
      <div id="margensEdicao" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
        </div>
      <button onclick="salvarMargens()" class="mt-6 w-full md:w-auto bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-200 ease-in-out">
        Guardar Margens y Descargar JSON
      </button>
    </div>

    <h3 class="text-2xl font-semibold text-gray-800 mb-4 mt-6">Productos</h3>
    <div id="produtos" class="space-y-4"></div>
    <button onclick="adicionarProduto()" class="mt-4 w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-200 ease-in-out">
      Agregar Producto
    </button>

    <h3 class="text-2xl font-semibold text-gray-800 mb-4 mt-6">Opciones de Cuotas</h3>
    <div id="opcoesParcelamento" class="space-y-4"></div>
    <button onclick="adicionarParcela()" class="mt-4 w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-200 ease-in-out">
      Agregar Opción de Cuotas
    </button>
    
    <div class="mt-6 p-4 bg-purple-50 border border-purple-200 rounded-lg shadow-sm">
      <div class="flex items-center">
        <input type="checkbox" id="alContadoCheckbox" class="h-5 w-5 text-purple-600 focus:ring-purple-500 border-gray-300 rounded">
        <label for="alContadoCheckbox" class="ml-3 block text-lg font-medium text-gray-800">Mostrar Opción Al Contado</label>
      </div>
    </div>

    <div class="flex flex-col md:flex-row gap-4 mt-8">
      <button onclick="calcularParcelas()" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-200 ease-in-out">
        Calcular Cuotas
      </button>
      <button onclick="gerarPDF()" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-200 ease-in-out">
        Generar PDF
      </button>
    </div>

    <div class="resumo bg-blue-50 border border-blue-200 text-blue-800 p-6 rounded-lg mt-8 shadow-inner">
      <strong class="block text-xl font-bold mb-2">Resumen:</strong>
      <div id="resumoContent">Ningún cálculo realizado aún.</div>
    </div>
    <div class="resultado bg-green-50 border border-green-200 text-green-800 p-6 rounded-lg mt-6 shadow-inner">
      <strong class="block text-xl font-bold mb-2">Resultados Detallados:</strong>
      <div id="resultadoContent">Ningún cálculo realizado aún.</div>
    </div>

    <div id="customModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
      <div class="bg-white p-8 rounded-lg shadow-xl max-w-sm w-full text-center">
        <h4 id="modalTitle" class="text-2xl font-bold mb-4 text-gray-800"></h4>
        <p id="modalMessage" class="text-gray-700 mb-6"></p>
        <button onclick="closeModal()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-5 rounded-lg shadow-md transition duration-200 ease-in-out">
          OK
        </button>
      </div>
    </div>

    <div id="passwordModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
      <div class="bg-white p-8 rounded-lg shadow-xl max-w-sm w-full text-center">
        <h4 class="text-2xl font-bold mb-4 text-gray-800">Ingrese la Contraseña</h4>
        <input type="password" id="passwordInput" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm mb-4" placeholder="Contraseña">
        <button onclick="verificarSenha()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-5 rounded-lg shadow-md transition duration-200 ease-in-out">
          Confirmar
        </button>
        <button onclick="closePasswordModal()" class="bg-gray-400 hover:bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg shadow-md transition duration-200 ease-in-out ml-2">
          Cancelar
        </button>
      </div>
    </div>

  </div>

  <script>
    let indexProduto = 0;
    let indexParcela = 0;
    let produtos = [];
    let opcoesParcelas = [];
    let dadosProdutos = []; // Armazenará os dados carregados do JSON
    let modoEdicaoAtivo = false;
    const MAX_PARCELAS_EDIT = 20; // Define o número máximo de parcelas para edição
    const SENHA_MODO_EDICAO = "1234567"; // Senha para entrar no modo de edição
    const MARGEM_AL_CONTADO = 20; // Margem fixa para "Al Contado"

    // Variável global para armazenar a imagem do logo carregada para o PDF
    let logoDataUrl = ''; 

    function showModal(title, message) {
      document.getElementById('modalTitle').innerText = title;
      document.getElementById('modalMessage').innerText = message;
      document.getElementById('customModal').classList.remove('hidden');
    }

    function closeModal() {
      document.getElementById('customModal').classList.add('hidden');
    }

    function showPasswordModal() {
      document.getElementById('passwordModal').classList.remove('hidden');
      document.getElementById('passwordInput').value = ''; // Limpa o campo da senha
      document.getElementById('passwordInput').focus(); // Foca no campo da senha
    }

    function closePasswordModal() {
      document.getElementById('passwordModal').classList.add('hidden');
    }

    function verificarSenha() {
      const inputSenha = document.getElementById('passwordInput').value;
      if (inputSenha === SENHA_MODO_EDICAO) {
        closePasswordModal();
        toggleModoEdicao(); // Entra no modo de edição
      } else {
        showModal('Error', 'Contraseña incorrecta. Inténtelo de nuevo.');
        document.getElementById('passwordInput').value = ''; // Limpa o campo
      }
    }

    function tentarEntrarModoEdicao() {
        if (modoEdicaoAtivo) {
            toggleModoEdicao(); // Se já estiver ativo, sai do modo
        } else {
            showPasswordModal(); // Se não estiver ativo, pede a senha
        }
    }

    function adicionarProduto() {
      const div = document.createElement('div');
      div.className = 'produto-item flex flex-col md:flex-row items-stretch md:items-center gap-4 p-4 bg-gray-50 rounded-lg shadow-sm';
      div.innerHTML = `
        <div class="flex-1">
          <label for="nome_${indexProduto}" class="block text-sm font-medium text-gray-700 mb-1">Producto</label>
          <select onchange="atualizarCusto(this, ${indexProduto})" id="nome_${indexProduto}"
            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
            <option value="">Seleccione un producto</option>
            ${dadosProdutos.map(p => `<option value="${p.codigo}">${p.codigo} - ${p.nome}</option>`).join('')}
          </select>
        </div>
        <div class="flex-1">
          <label for="custo_${indexProduto}" class="block text-sm font-medium text-gray-700 mb-1">Costo Unitario (Gs)</label>
          <input type="number" placeholder="Costo Unitario (Gs)" id="custo_${indexProduto}" readonly
            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100 cursor-not-allowed sm:text-sm">
        </div>
        <div class="flex-1">
          <label for="qtd_${indexProduto}" class="block text-sm font-medium text-gray-700 mb-1">Cantidad</label>
          <input type="number" placeholder="Cantidad" id="qtd_${indexProduto}" min="1" value="1"
            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
        </div>
        <button onclick="removerProduto(this)"
          class="mt-auto bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-sm transition duration-200 ease-in-out self-end md:self-center">
          Eliminar
        </button>
      `;
      document.getElementById('produtos').appendChild(div);
      indexProduto++;
    }

    function removerProduto(button) {
      button.parentElement.remove();
    }

    function atualizarCusto(select, index) {
      const produto = dadosProdutos.find(p => String(p.codigo) === select.value);
      if (produto) {
        document.getElementById(`custo_${index}`).value = produto.custo;
      } else {
        document.getElementById(`custo_${index}`).value = '';
      }
    }

    function adicionarParcela() {
      const div = document.createElement('div');
      div.className = 'parcela-opcao flex flex-col md:flex-row items-stretch md:items-center gap-4 p-4 bg-gray-50 rounded-lg shadow-sm';
      div.innerHTML = `
        <div class="flex-1">
          <label for="parcelas_${indexParcela}" class="block text-sm font-medium text-gray-700 mb-1">Número de Cuotas</label>
          <input type="number" placeholder="Cuotas" id="parcelas_${indexParcela}" min="1"
            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
        </div>
        <button onclick="this.parentElement.remove()"
          class="mt-auto bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-sm transition duration-200 ease-in-out self-end md:self-center">
          Eliminar
        </button>
      `;
      document.getElementById('opcoesParcelamento').appendChild(div);
      indexParcela++;
    }

    function formatar(valor) {
      return Math.round(valor).toLocaleString('de-DE'); // Formato para Gs (Guaranis)
    }

    function calcularParcelas() {
      produtos = [];
      opcoesParcelas = [];

      const selects = document.querySelectorAll('[id^=nome_]');
      selects.forEach((s, i) => {
        const codigo = s.value;
        const qtdInput = document.getElementById(`qtd_${i}`);
        const custoInput = document.getElementById(`custo_${i}`);

        if (!codigo || !qtdInput || !custoInput) {
            console.warn(`Skipping incomplete product entry at index ${i}`);
            return;
        }

        const qtd = parseInt(qtdInput.value);
        const custo = parseFloat(custoInput.value);

        if (codigo && !isNaN(qtd) && qtd > 0 && !isNaN(custo) && custo >= 0) {
          produtos.push({ codigo, qtd, custo });
        } else {
            showModal('Error de Entrada', 'Por favor, complete todos los campos de producto con valores válidos (cantidad > 0, costo >= 0).');
            produtos = [];
            return;
        }
      });

      const parcelasInputs = document.querySelectorAll('[id^=parcelas_]');
      parcelasInputs.forEach(p => {
        const parcelas = parseInt(p.value);
        if (!isNaN(parcelas) && parcelas > 0) {
          opcoesParcelas.push({ parcelas });
        } else {
            showModal('Error de Entrada', 'Por favor, complete todos los campos de cuotas con valores válidos (cuotas > 0).');
            opcoesParcelas = [];
            return;
        }
      });
      
      if (produtos.length === 0) {
        showModal('Aviso', 'Por favor, agregue al menos un producto antes de calcular.');
        document.getElementById('resultadoContent').innerHTML = 'Ningún cálculo realizado aún.';
        document.getElementById('resumoContent').innerHTML = 'Ningún cálculo realizado aún.';
        return;
      }

      let resultadoHTML = '';
      let resumoHTML = '';
      let alContadoAtivo = document.getElementById('alContadoCheckbox').checked;

      // Calcular "Al Contado" si el checkbox está marcado
      if (alContadoAtivo) {
        resultadoHTML += `<h4 class="text-xl font-semibold text-gray-700 mb-2 mt-4">Al Contado</h4>`;
        let totalAlContado = 0;
        produtos.forEach(prod => {
          const info = dadosProdutos.find(p => String(p.codigo) === String(prod.codigo));
          if (!info) {
            console.error(`Product info not found for code: ${prod.codigo}`);
            return;
          }
          const total = prod.custo * prod.qtd;
          const totalComMargem = total * (1 + MARGEM_AL_CONTADO / 100);
          totalAlContado += totalComMargem;
          resultadoHTML += `<p class="text-gray-700">${info.nome} (CANT: ${prod.qtd}) → Gs ${formatar(totalComMargem)}</p>`;
        });
        resultadoHTML += `<p class="text-lg font-bold text-gray-800 mt-2">Total Al Contado Gs <strong>${formatar(totalAlContado)}</strong></p>`;
        resumoHTML += `<p class="text-gray-700">Al Contado Gs <strong>${formatar(totalAlContado)}</strong></p>`;
      }

      // Calcular las opciones de parcelas
      if (opcoesParcelas.length > 0) {
        opcoesParcelas.forEach(op => {
          resultadoHTML += `<h4 class="text-xl font-semibold text-gray-700 mb-2 mt-4">${op.parcelas} Cuotas</h4>`;
          let totalParcela = 0;
          produtos.forEach(prod => {
            const info = dadosProdutos.find(p => String(p.codigo) === String(prod.codigo));
            if (!info) {
              console.error(`Product info not found for code: ${prod.codigo}`);
              return;
            }

            // Busca la margen del JSON para el número de parcelas. Si no encuentra, asume 0.
            const margem = (info[`margem_${op.parcelas}`] !== undefined ? parseFloat(info[`margem_${op.parcelas}`]) : 0);
            
            const total = prod.custo * prod.qtd;
            const totalComMargem = total * (1 + margem / 100);
            const valorParcela = totalComMargem / op.parcelas;
            totalParcela += valorParcela;
            resultadoHTML += `<p class="text-gray-700">${info.nome} (CANT: ${prod.qtd}) → ${op.parcelas} x Gs ${formatar(valorParcela)}</p>`;
          });
          resultadoHTML += `<p class="text-lg font-bold text-gray-800 mt-2">Total ${op.parcelas} x Gs <strong>${formatar(totalParcela)}</strong></p>`;
          resumoHTML += `<p class="text-gray-700">${op.parcelas} cuotas de Gs <strong>${formatar(totalParcela)}</strong></p>`;
        });
      } else if (!alContadoAtivo) {
          showModal('Aviso', 'Por favor, agregue al menos una opción de cuotas o seleccione "Mostrar Opción Al Contado" antes de calcular.');
          document.getElementById('resultadoContent').innerHTML = 'Ningún cálculo realizado aún.';
          document.getElementById('resumoContent').innerHTML = 'Ningún cálculo realizado aún.';
          return;
      }


      document.getElementById('resultadoContent').innerHTML = resultadoHTML;
      document.getElementById('resumoContent').innerHTML = `<strong>Resumen:</strong><br>${resumoHTML}`;
    }

    async function gerarPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 20;

      // Adiciona o logo se estiver carregado
      if (logoDataUrl) {
          const logoWidth = 50;
          const logoHeight = 20;
          const logoX = (doc.internal.pageSize.width - logoWidth) / 2;
          const logoY = 10;
          doc.addImage(logoDataUrl, 'PNG', logoX, logoY, logoWidth, logoHeight);
          y = logoY + logoHeight + 10;
      }

      doc.setFont("helvetica", "bold");
      doc.setFontSize(20);
      doc.text("Presupuesto de Productos", 105, y, { align: "center" });
      y += 20;

      if (produtos.length === 0) {
        showModal('Aviso', 'Por favor, agregue productos antes de generar el PDF.');
        return;
      }

      let alContadoAtivo = document.getElementById('alContadoCheckbox').checked;
      if (opcoesParcelas.length === 0 && !alContadoAtivo) {
          showModal('Aviso', 'Por favor, agregue al menos una opción de cuotas o seleccione "Mostrar Opción Al Contado" antes de generar el PDF.');
          return;
      }

      // Se "Al Contado" estiver ativo, adiciona ao PDF
      if (alContadoAtivo) {
        if (y + 40 > doc.internal.pageSize.height - 20) {
          doc.addPage();
          y = 20;
          if (logoDataUrl) {
              const logoWidth = 50; 
              const logoHeight = 20;
              const logoX = (doc.internal.pageSize.width - logoWidth) / 2;
              const logoY = 10;
              doc.addImage(logoDataUrl, 'PNG', logoX, logoY, logoWidth, logoHeight);
              y = logoY + logoHeight + 10; 
          }
          doc.setFont("helvetica", "bold");
          doc.setFontSize(20);
          doc.text("Presupuesto de Productos", 105, y, { align: "center" });
          y += 20;
        }

        doc.setFont("helvetica", "bold");
        doc.setFontSize(16);
        doc.text("Al Contado", 20, y);
        y += 10;

        doc.setFont("helvetica", "bold");
        doc.setFontSize(10);

        const startYAlContado = y;
        const colXAlContado = [20, 100, 160]; // Ajustado para 3 colunas
        const colWidthAlContado = [80, 25, 45]; // Ajustado para 3 colunas

        doc.setFillColor(230, 230, 230);
        doc.rect(colXAlContado[0], startYAlContado, colWidthAlContado[0] + colWidthAlContado[1] + colWidthAlContado[2], 7, "F");

        doc.text("Producto", colXAlContado[0] + 2, startYAlContado + 5);
        doc.text("Cant.", colXAlContado[1] + 2, startYAlContado + 5);
        doc.text("Valor", colXAlContado[2] + 2, startYAlContado + 5);
        y += 7;

        doc.setFont("helvetica", "normal");
        doc.line(colXAlContado[0], startYAlContado, colXAlContado[0] + colWidthAlContado[0] + colWidthAlContado[1] + colWidthAlContado[2], startYAlContado);

        let totalAlContado = 0;
        produtos.forEach(prod => {
          if (y + 20 > doc.internal.pageSize.height - 20) {
            doc.addPage();
            y = 20;
            if (logoDataUrl) {
                const logoWidth = 50; 
                const logoHeight = 20;
                const logoX = (doc.internal.pageSize.width - logoWidth) / 2;
                const logoY = 10;
                doc.addImage(logoDataUrl, 'PNG', logoX, logoY, logoWidth, logoHeight);
                y = logoY + logoHeight + 10; 
            }
            doc.setFont("helvetica", "bold");
            doc.setFontSize(20);
            doc.text("Presupuesto de Productos", 105, y, { align: "center" });
            y += 20;

            doc.setFont("helvetica", "bold");
            doc.setFontSize(10);
            doc.setFillColor(230, 230, 230);
            doc.rect(colXAlContado[0], y, colWidthAlContado[0] + colWidthAlContado[1] + colWidthAlContado[2], 7, "F");
            doc.text("Producto", colXAlContado[0] + 2, y + 5);
            doc.text("Cant.", colXAlContado[1] + 2, y + 5);
            doc.text("Valor", colXAlContado[2] + 2, y + 5);
            y += 7;
            doc.setFont("helvetica", "normal");
            doc.line(colXAlContado[0], y - 7, colXAlContado[0] + colWidthAlContado[0] + colWidthAlContado[1] + colWidthAlContado[2], y - 7);
          }

          const info = dadosProdutos.find(p => String(p.codigo) === String(prod.codigo));
          if (!info) return;
          const total = prod.custo * prod.qtd;
          const totalComMargem = total * (1 + MARGEM_AL_CONTADO / 100);
          totalAlContado += totalComMargem;

          const productName = info.nome;
          const textHeight = doc.getLineHeight() / doc.internal.scaleFactor;
          const lineSpacing = 1; 
          const splitText = doc.splitTextToSize(productName, colWidthAlContado[0] - 4);
          
          let currentYForText = y + 5;
          splitText.forEach(line => {
              doc.text(line, colXAlContado[0] + 2, currentYForText);
              currentYForText += (textHeight + lineSpacing);
          });

          doc.text(String(prod.qtd), colXAlContado[1] + 2, y + 5);
          doc.text(`Gs ${formatar(totalComMargem)}`, colXAlContado[2] + 2, y + 5);
          
          const rowHeight = Math.max(10, (splitText.length * (textHeight + lineSpacing)) + 2);
          y += rowHeight; 
          
          doc.line(colXAlContado[0], y, colXAlContado[0] + colWidthAlContado[0] + colWidthAlContado[1] + colWidthAlContado[2], y);
        });

        doc.line(colXAlContado[0], startYAlContado, colXAlContado[0], y);
        doc.line(colXAlContado[0] + colWidthAlContado[0], startYAlContado, colXAlContado[0] + colWidthAlContado[0], y);
        doc.line(colXAlContado[0] + colWidthAlContado[0] + colWidthAlContado[1], startYAlContado, colXAlContado[0] + colWidthAlContado[0] + colWidthAlContado[1], y);
        doc.line(colXAlContado[0] + colWidthAlContado[0] + colWidthAlContado[1] + colWidthAlContado[2], startYAlContado, colXAlContado[0] + colWidthAlContado[0] + colWidthAlContado[1] + colWidthAlContado[2], y);

        doc.setFont("helvetica", "bold");
        doc.setFontSize(12);
        y += 5;
        doc.text(`Total Al Contado Gs ${formatar(totalAlContado)}`, 20, y);
        y += 15;
      }

      // Adiciona as opções de parcelamento se houver
      opcoesParcelas.forEach(op => {
        if (y + 40 > doc.internal.pageSize.height - 20) {
          doc.addPage();
          y = 20;
          if (logoDataUrl) {
              const logoWidth = 50; 
              const logoHeight = 20;
              const logoX = (doc.internal.pageSize.width - logoWidth) / 2;
              const logoY = 10;
              doc.addImage(logoDataUrl, 'PNG', logoX, logoY, logoWidth, logoHeight);
              y = logoY + logoHeight + 10; 
          }
          doc.setFont("helvetica", "bold");
          doc.setFontSize(20);
          doc.text("Presupuesto de Productos", 105, y, { align: "center" });
          y += 20;
        }

        doc.setFont("helvetica", "bold");
        doc.setFontSize(16);
        doc.text(`${op.parcelas} Cuotas`, 20, y);
        y += 10;

        doc.setFont("helvetica", "bold");
        doc.setFontSize(10);

        const startY = y;
        const colX = [20, 100, 125, 160];
        const colWidth = [80, 25, 35, 45];

        doc.setFillColor(230, 230, 230);
        doc.rect(colX[0], startY, colWidth[0] + colWidth[1] + colWidth[2] + colWidth[3], 7, "F");

        doc.text("Producto", colX[0] + 2, startY + 5);
        doc.text("Cant.", colX[1] + 2, startY + 5);
        doc.text("Cuotas", colX[2] + 2, startY + 5);
        doc.text("Valor Cuota", colX[3] + 2, startY + 5);
        y += 7;

        doc.setFont("helvetica", "normal");
        doc.line(colX[0], startY, colX[0] + colWidth[0] + colWidth[1] + colWidth[2] + colWidth[3], startY);

        let totalParcela = 0;
        produtos.forEach(prod => {
          if (y + 20 > doc.internal.pageSize.height - 20) {
            doc.addPage();
            y = 20;
            if (logoDataUrl) {
                const logoWidth = 50; 
                const logoHeight = 20;
                const logoX = (doc.internal.pageSize.width - logoWidth) / 2;
                const logoY = 10;
                doc.addImage(logoDataUrl, 'PNG', logoX, logoY, logoWidth, logoHeight);
                y = logoY + logoHeight + 10; 
            }
            doc.setFont("helvetica", "bold");
            doc.setFontSize(20);
            doc.text("Presupuesto de Productos", 105, y, { align: "center" });
            y += 20;

            doc.setFont("helvetica", "bold");
            doc.setFontSize(10);
            doc.setFillColor(230, 230, 230);
            doc.rect(colX[0], y, colWidth[0] + colWidth[1] + colWidth[2] + colWidth[3], 7, "F");
            doc.text("Producto", colX[0] + 2, y + 5);
            doc.text("Cant.", colX[1] + 2, y + 5);
            doc.text("Cuotas", colX[2] + 2, y + 5);
            doc.text("Valor Cuota", colX[3] + 2, y + 5);
            y += 7;
            doc.setFont("helvetica", "normal");
            doc.line(colX[0], y - 7, colX[0] + colWidth[0] + colWidth[1] + colWidth[2] + colWidth[3], y - 7);
          }

          const info = dadosProdutos.find(p => String(p.codigo) === String(prod.codigo));
          if (!info) return;

          const margem = (info[`margem_${op.parcelas}`] !== undefined ? parseFloat(info[`margem_${op.parcelas}`]) : 0);
          const total = prod.custo * prod.qtd;
          const totalComMargem = total * (1 + margem / 100);
          const valorParcela = totalComMargem / op.parcelas;
          totalParcela += valorParcela;

          const productName = info.nome;
          const textHeight = doc.getLineHeight() / doc.internal.scaleFactor;
          const lineSpacing = 1; 
          const splitText = doc.splitTextToSize(productName, colWidth[0] - 4);
          
          let currentYForText = y + 5;
          splitText.forEach(line => {
              doc.text(line, colX[0] + 2, currentYForText);
              currentYForText += (textHeight + lineSpacing);
          });

          doc.text(String(prod.qtd), colX[1] + 2, y + 5);
          doc.text(String(op.parcelas), colX[2] + 2, y + 5);
          doc.text(`Gs ${formatar(valorParcela)}`, colX[3] + 2, y + 5);
          
          const rowHeight = Math.max(10, (splitText.length * (textHeight + lineSpacing)) + 2);
          y += rowHeight; 
          
          doc.line(colX[0], y, colX[0] + colWidth[0] + colWidth[1] + colWidth[2] + colWidth[3], y);
        });

        doc.line(colX[0], startY, colX[0], y);
        doc.line(colX[0] + colWidth[0], startY, colX[0] + colWidth[0], y);
        doc.line(colX[0] + colWidth[0] + colWidth[1], startY, colX[0] + colWidth[0] + colWidth[1], y);
        doc.line(colX[0] + colWidth[0] + colWidth[1] + colWidth[2], startY, colX[0] + colWidth[0] + colWidth[1] + colWidth[2], y);
        doc.line(colX[0] + colWidth[0] + colWidth[1] + colWidth[2] + colWidth[3], startY, colX[0] + colWidth[0] + colWidth[1] + colWidth[2] + colWidth[3], y);

        doc.setFont("helvetica", "bold");
        doc.setFontSize(12);
        y += 5;
        doc.text(`Total ${op.parcelas} x Gs ${formatar(totalParcela)}`, 20, y);
        y += 15;
      });

      doc.save("presupuesto.pdf");
      showModal('PDF Generado', '¡El archivo "presupuesto.pdf" fue generado con éxito!');
    }

    // --- FUNÇÕES PARA O MODO DE EDIÇÃO DE MARGENS ---

    function toggleModoEdicao() {
      modoEdicaoAtivo = !modoEdicaoAtivo;
      const btnModoEdicion = document.getElementById('btnModoEdicion');
      const painelEdicao = document.getElementById('painelEdicaoMargens');
      const selectProdutoEdicao = document.getElementById('selectProdutoEdicao');

      if (modoEdicaoAtivo) {
        btnModoEdicion.innerText = 'Salir del Modo Edición';
        btnModoEdicion.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
        btnModoEdicion.classList.add('bg-gray-500', 'hover:bg-gray-600');
        painelEdicao.classList.remove('hidden');

        // Popular o select de produtos no modo de edição
        selectProdutoEdicao.innerHTML = `<option value="">Seleccione un producto</option>` +
          dadosProdutos.map(p => `<option value="${p.codigo}">${p.codigo} - ${p.nome}</option>`).join('');
        
        // Limpar margens ao entrar no modo de edição
        document.getElementById('margensEdicao').innerHTML = '';

      } else {
        btnModoEdicion.innerText = 'Entrar en Modo Edición';
        btnModoEdicion.classList.remove('bg-gray-500', 'hover:bg-yellow-600');
        btnModoEdicion.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
        painelEdicao.classList.add('hidden');
      }
    }

    function popularMargensEdicao() {
      const selectProdutoEdicao = document.getElementById('selectProdutoEdicao');
      const codigoProduto = selectProdutoEdicao.value;
      const margensEdicaoDiv = document.getElementById('margensEdicao');
      margensEdicaoDiv.innerHTML = ''; // Limpa as margens existentes

      if (codigoProduto) {
        const produtoParaEditar = dadosProdutos.find(p => String(p.codigo) === codigoProduto);
        if (produtoParaEditar) {
          // Não adiciona a margem para "Al Contado" aqui.
          // Apenas as margens de parcelamento (1 a 20) serão exibidas.
          for (let i = 1; i <= MAX_PARCELAS_EDIT; i++) { 
            const margemAtual = produtoParaEditar[`margem_${i}`] || 0;
            const divMargem = document.createElement('div');
            divMargem.className = 'flex items-center gap-2';
            
            const inputClass = `flex-1 px-2 py-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm`;

            divMargem.innerHTML = `
              <label for="margem_${i}" class="text-sm font-medium text-gray-700">${i} Cuotas:</label>
              <input type="number" id="margem_input_${i}" value="${margemAtual}" step="0.01"
                class="${inputClass}">
            `;
            margensEdicaoDiv.appendChild(divMargem);
          }
        }
      }
    }

    function salvarMargens() {
      const selectProdutoEdicao = document.getElementById('selectProdutoEdicao');
      const codigoProduto = selectProdutoEdicao.value;

      if (!codigoProduto) {
        showModal('Error', 'Por favor, seleccione un producto para guardar las margenes.');
        return;
      }

      const produtoIndex = dadosProdutos.findIndex(p => String(p.codigo) === codigoProduto);
      if (produtoIndex === -1) {
        showModal('Error', 'Producto no encontrado para edición.');
        return;
      }

      // A margem "Al Contado" não é salva no JSON, é uma constante separada.
      // As margens de parcelamento são salvas.
      for (let i = 1; i <= MAX_PARCELAS_EDIT; i++) { 
        const inputMargem = document.getElementById(`margem_input_${i}`);
        if (inputMargem) {
          const novaMargem = parseFloat(inputMargem.value);
          dadosProdutos[produtoIndex][`margem_${i}`] = isNaN(novaMargem) ? 0 : novaMargem;
        }
      }

      const dadosParaDownload = dadosProdutos.map(prod => {
          const obj = {
              "cod.": prod.codigo,
              "Custo": prod.custo,
              "Mercadoria": prod.nome
          };
          // Garante que todas as colunas de parcelas estejam no JSON
          for(let i=1; i<=MAX_PARCELAS_EDIT; i++) {
              obj[`${i} parcela`] = prod[`margem_${i}`];
          }
          return obj;
      });

      const jsonString = JSON.stringify(dadosParaDownload, null, 2);
      const blob = new Blob([jsonString], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'dados_produtos.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showModal('Margens Guardadas', '¡Margens actualizadas y nuevo archivo JSON "dados_produtos.json" generado para descarga! Por favor, reemplace el archivo original con este nuevo JSON en la misma carpeta y recargue la página.');
      
      // Re-popula os selects de produto para garantir que as margens atualizadas sejam refletidas
      document.querySelectorAll('[id^=nome_]').forEach((selectElement, i) => {
          const currentSelectedValue = selectElement.value;
          selectElement.innerHTML = `<option value="">Seleccione un producto</option>` +
              dadosProdutos.map(p => `<option value="${p.codigo}">${p.codigo} - ${p.nome}</option>`).join('');
          selectElement.value = currentSelectedValue;
          atualizarCusto(selectElement, i);
      });
    }

    async function loadLogoForPDF() {
        try {
            const response = await fetch('logo.png');
            if (!response.ok) {
                console.warn('Advertencia: El archivo de logo "logo.png" no fue encontrado. El PDF se generará sin logo.');
                return;
            }
            const blob = await response.blob();
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    resolve(reader.result);
                };
                reader.readAsDataURL(blob);
            });
        } catch (error) {
            console.error('Error al cargar la imagen del logo:', error);
            return null;
        }
    }

    async function carregarDadosProdutos() {
        const loadingIndicator = document.getElementById('loadingIndicator');
        const fileNameSpan = document.getElementById('fileName');

        fileNameSpan.innerText = 'Cargando datos del archivo JSON...';
        loadingIndicator.classList.remove('hidden');

        try {
            const response = await fetch('dados_produtos.json');

            if (!response.ok) {
                throw new Error(`Error HTTP! estado: ${response.status}. Asegúrese de que 'dados_produtos.json' esté en la misma carpeta.`);
            }
            const rawData = await response.json();

            if (!Array.isArray(rawData) || rawData.length === 0) {
                throw new Error("El archivo JSON está vacío o no es un array de objetos.");
            }

            dadosProdutos = rawData.map(row => {
                const produto = {
                    codigo: String(row['cod.']),
                    custo: parseFloat(row['Custo']),
                    nome: row['Mercadoria']
                };

                for (let i = 1; i <= MAX_PARCELAS_EDIT; i++) {
                    let margemValue;
                    let keyOptions = [`${i} parcela`, `${i} PARCELA`, `parcela ${i}`];
                    
                    let foundKey = false;
                    for (let k = 0; k < keyOptions.length; k++) {
                        if (row[keyOptions[k]] !== undefined && row[keyOptions[k]] !== '') {
                            margemValue = parseFloat(row[keyOptions[k]]);
                            foundKey = true;
                            break;
                        }
                    }

                    // Si no encontró en el JSON, define como 0 para parcelas.
                    // La margen de "Al Contado" es fija y no viene del JSON.
                    produto[`margem_${i}`] = (margemValue !== undefined && !isNaN(margemValue)) ? margemValue : 0;
                }
                return produto;
            });

            loadingIndicator.classList.add('hidden');
            fileNameSpan.innerText = 'Datos cargados con éxito de dados_produtos.json.';
            showModal('Éxito', '¡Datos de productos cargados con éxito de dados_produtos.json!');

            // Atualiza os selects de produto após carregar os dados
            document.querySelectorAll('[id^=nome_]').forEach((selectElement, i) => {
                const currentSelectedValue = selectElement.value;
                selectElement.innerHTML = `<option value="">Seleccione un producto</option>` +
                    dadosProdutos.map(p => `<option value="${p.codigo}">${p.codigo} - ${p.nome}</option>`).join('');
                selectElement.value = currentSelectedValue; // Mantém a seleção se houver
                atualizarCusto(selectElement, i);
            });

        } catch (error) {
            loadingIndicator.classList.add('hidden');
            fileNameSpan.innerText = 'Error al cargar datos del archivo JSON.';
            showModal('Error al Cargar Datos', `Ocurrió un error al cargar los datos: ${error.message}. Asegúrese de que 'dados_produtos.json' exista y sea un JSON válido.`);
            console.error("Error loading product data:", error);
        }
    }

    window.onload = async function() {
        await carregarDadosProdutos();
        adicionarProduto();
        // Pode adicionar uma parcela padrão ao carregar, ou deixar o usuário adicionar
        adicionarParcela(); 
        logoDataUrl = await loadLogoForPDF();
    };
  </script>
</body>
</html>
